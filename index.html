<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 è¬é¦¬å¥”é¨°ãƒ»å¥åº·è³“æœ RPG</title>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ React å’Œ Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- å¼•å…¥ Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
    
    <!-- å¼•å…¥ Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #7f1d1d; }

        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-6px); } 100% { transform: translateY(0px); } }
        @keyframes shake-hard { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        @keyframes hit-effect { 0% { transform: scale(1); opacity: 0; } 50% { transform: scale(1.5); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }
        
        .animate-float { animation: float 4s ease-in-out infinite; }
        .animate-shake-hard { animation: shake-hard 0.5s; }
        .animate-hit { animation: hit-effect 0.4s ease-out forwards; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .golden-text {
            background: linear-gradient(to bottom, #d97706, #b45309);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-gradient-to-b from-[#991b1b] to-[#7f1d1d] text-slate-800 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICON SYSTEM ---
        const toPascalCase = (str) => str.replace(/(^|-)([a-z0-9])/g, (g) => g.toUpperCase().replace('-', ''));

        const Icon = ({ name, size = 24, className = "" }) => {
            const [svgHtml, setSvgHtml] = useState("");
            useEffect(() => {
                const pascalName = toPascalCase(name);
                if (window.lucide && window.lucide.icons && window.lucide.icons[pascalName]) {
                    setSvgHtml(window.lucide.icons[pascalName].toSvg({ width: size, height: size, class: className }));
                }
            }, [name, size, className]);
            if (!svgHtml) return <span className={`inline-block w-${size} h-${size}`}></span>;
            return <span dangerouslySetInnerHTML={{ __html: svgHtml }} className="inline-flex items-center justify-center" />;
        };

        // Icons
        const Trophy = (p) => <Icon name="trophy" {...p} />;
        const Sword = (p) => <Icon name="sword" {...p} />;
        const Gift = (p) => <Icon name="gift" {...p} />;
        const Scroll = (p) => <Icon name="scroll" {...p} />;
        const Wand2 = (p) => <Icon name="wand-2" {...p} />;
        const Share2 = (p) => <Icon name="share-2" {...p} />;
        const RotateCcw = (p) => <Icon name="rotate-ccw" {...p} />;
        const Flame = (p) => <Icon name="flame" {...p} />;
        const Droplets = (p) => <Icon name="droplets" {...p} />;
        const Moon = (p) => <Icon name="moon" {...p} />;
        const Activity = (p) => <Icon name="activity" {...p} />;
        const Utensils = (p) => <Icon name="utensils" {...p} />;
        const QrCode = (p) => <Icon name="qr-code" {...p} />;
        const Check = (p) => <Icon name="check" {...p} />;
        const Zap = (p) => <Icon name="zap" {...p} />;
        const Send = (p) => <Icon name="send" {...p} />;
        const Edit3 = (p) => <Icon name="edit-3" {...p} />;
        const Bot = (p) => <Icon name="bot" {...p} />;
        const Shuffle = (p) => <Icon name="shuffle" {...p} />;
        const MousePointer2 = (p) => <Icon name="mouse-pointer-2" {...p} />;
        const Crown = (p) => <Icon name="crown" {...p} />;
        const Sparkles = (p) => <Icon name="sparkles" {...p} />;
        const Gamepad2 = (p) => <Icon name="gamepad-2" {...p} />;
        const Wind = (p) => <Icon name="wind" {...p} />;
        const ExternalLink = (p) => <Icon name="external-link" {...p} />;
        const Heart = (p) => <Icon name="heart" {...p} />;

        // --- GAME DATA ---
        const getIcon = (id, type) => {
            if (id === 1 || id === 19) return <Droplets size={18} />; 
            if (id === 8) return <Flame size={18} />; 
            if (id === 10 || id === 22) return <Moon size={18} />; 
            if (id === 21) return <Share2 size={18} />; 
            if (id === 13) return <Trophy size={24} className="text-yellow-600" />; 
            if (id === 25) return <Trophy size={18} />; 
            switch (type) {
                case 'diet': return <Utensils size={18} />;
                case 'exercise': return <Activity size={18} />;
                default: return <Activity size={18} />;
            }
        };

        const BOSS_MAX_HP = 500; 

        const PRIZE_POOL = [
            { id: 'p1', name: 'é»ƒé‡‘è¬å…©é¦¬', rarity: 'SSR', chance: 0.05, icon: 'ğŸ', color: 'text-yellow-600 bg-yellow-50 border-yellow-200', desc: 'é¦¬å¹´è¡Œå¤§é‹ï¼é‹æ°£çˆ†æ£šï¼' },
            { id: 'p2', name: 'åƒé‡Œèµ¤å…”é¦¬', rarity: 'SR', chance: 0.15, icon: 'ğŸ´', color: 'text-red-600 bg-red-50 border-red-200', desc: 'æ´»åŠ›å……æ²›ï¼Œæ—¥è¡Œåƒé‡Œã€‚' },
            { id: 'p3', name: 'å¤¢å¹»ç¨è§’ç¸', rarity: 'SR', chance: 0.15, icon: 'ğŸ¦„', color: 'text-purple-600 bg-purple-50 border-purple-200', desc: 'å„ªé›…è¿·äººï¼Œé­…åŠ›å››å°„ã€‚' },
            { id: 'p4', name: 'ç¿ ç‰ç™½èœé¦¬', rarity: 'R', chance: 0.25, icon: 'ğŸ¥¬', color: 'text-green-600 bg-green-50 border-green-200', desc: 'é£²é£Ÿå‡è¡¡ï¼Œè…¸èƒƒå¥åº·ã€‚' },
            { id: 'p5', name: 'å¿«æ¨‚æ–æ–é¦¬', rarity: 'N', chance: 0.40, icon: 'ğŸ ', color: 'text-slate-600 bg-slate-50 border-slate-200', desc: 'ç«¥å¿ƒæœªæ³¯ï¼Œå¤©å¤©é–‹å¿ƒã€‚' },
        ];

        const FORTUNES = [
            { type: 'å¤§å‰', title: 'å¤©é¸ä¹‹äºº', text: 'æ–°é™³ä»£è¬å¦‚ç«ç®­ï¼Œæ€éº¼åƒéƒ½ä¸èƒ–ï¼ˆä½†ä¹Ÿåˆ¥å¤ªå›‚å¼µï¼‰ã€‚', color: 'text-red-600' },
            { type: 'ä¸­å‰', title: 'ç©©ç´®ç©©æ‰“', text: 'ä»Šæ—¥å®œæ·±è¹²ï¼Œæ ¸å¿ƒæœ‰åŠ›ï¼Œç´…åŒ…æ‹¿å¾—æ›´ç©©ã€‚', color: 'text-orange-500' },
            { type: 'å°å‰', title: 'å°ç¢ºå¹¸', text: 'å¤šå–æ°´é‹æ°£æœƒè®Šå¥½ï¼Œçš®è†šä¹Ÿæœƒè®Šäº®å–”ï¼', color: 'text-yellow-600' },
            { type: 'å‰', title: 'å¹³å®‰æ˜¯ç¦', text: 'æ—©ç¡æ—©èµ·èº«é«”å¥½ï¼Œè²¡ç¥çˆºæœ€æ„›ç²¾ç¥å¥½çš„äººã€‚', color: 'text-green-600' },
        ];

        const GREETING_OPTIONS = [
            { id: 'g1', label: 'å¤šå–æ°´', icon: <Droplets size={18}/>, blessing: 'è²¡æºæ»¾æ»¾ä¼¼æµæ°´ï¼Œçš®è†šæ°´å«©åˆQå½ˆï¼' },
            { id: 'g2', label: 'å¤šé‹å‹•', icon: <Activity size={18}/>, blessing: 'æ´»åŠ›å……æ²›åƒé‡é¦¬ï¼Œèº«æç·Šå¯¦äººäººèª‡ï¼' },
            { id: 'g3', label: 'å°‘åƒç³–', icon: <Utensils size={18}/>, blessing: 'ç”œèœœåœ¨å¿ƒä¸åœ¨èº«ï¼Œè¼•ç›ˆçªˆçª•éå¥½å¹´ï¼' },
            { id: 'g4', label: 'ç¡é£½é£½', icon: <Moon size={18}/>, blessing: 'ç¡å¾—å¥½äººä¸è€ï¼Œå®¹å…‰ç…¥ç™¼æ°£è‰²å¥½ï¼' },
            { id: 'g5', label: 'åƒè”¬èœ', icon: <Utensils size={18}/>, blessing: 'è…¸é“é †æš¢æ²’ç…©æƒ±ï¼Œå¥åº·é•·å£½åƒåˆ°è€ï¼' },
            { id: 'g6', label: 'å¥½å¿ƒæƒ…', icon: <Heart size={18}/>, blessing: 'ç¬‘å£å¸¸é–‹å¥½é‹ä¾†ï¼Œç…©æƒ±å£“åŠ›å…¨æ‹‹é–‹ï¼' },
        ];

        const GACHA_COST = 30;

        // Keyword Generation
        const getKeyword = (name) => {
            if (!name) return "å¥åº·";
            const keywords = ["è‡ªå¾‹", "æ ¸å¿ƒ", "å–æ°´", "æ·±è¹²", "æ—©ç¡", "æœ‰æ°§", "è”¬èœ", "æ¸›ç³–", "å¾®ç¬‘", "ä¼¸å±•"];
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            return keywords[Math.abs(hash) % keywords.length];
        };

        const BingoGame = () => {
            const initialGridData = [
                { id: 1, text: "é¤å‰å– 500cc æ°´", type: "diet" }, { id: 2, text: "åŸåœ°é–‹åˆè·³ 50 ä¸‹", type: "exercise" },
                { id: 3, text: "é€™é¤åªåƒä¸ƒåˆ†é£½", type: "diet" }, { id: 4, text: "é£¯å¾Œæ•£æ­¥ 15 åˆ†é˜", type: "exercise" },
                { id: 5, text: "æ‹’çµ•ä¸€æ¯å«ç³–é£²æ–™", type: "diet" }, { id: 6, text: "æ·±è¹² 20 ä¸‹", type: "exercise" },
                { id: 7, text: "åƒä¸€ç›¤æ·±ç¶ è‰²è”¬èœ", type: "diet" }, { id: 8, text: "å¹«å¿™åšå®¶äº‹ 20 åˆ†é˜", type: "life" },
                { id: 9, text: "å®Œå…¨ä¸æ²¾é†¬æ–™åƒä¸€é¤", type: "diet" }, { id: 10, text: "ç¡æ»¿ 7 å°æ™‚", type: "life" },
                { id: 11, text: "å¹³æ¿æ”¯æ’ 1 åˆ†é˜", type: "exercise" }, { id: 12, text: "çˆ¬æ¨“æ¢¯ä»£æ›¿é›»æ¢¯", type: "exercise" },
                { id: 13, text: "é¦¬å¹´å¤§å‰ (å…è²»)", type: "free", checked: true }, { id: 14, text: "æ°´æœä»£æ›¿é¤…ä¹¾é›¶é£Ÿ", type: "diet" },
                { id: 15, text: "ç«™è‘—æ‰“ç‰Œ/èŠå¤© 1 å±€", type: "life" }, { id: 16, text: "åšä¼¸å±•æ“ 10 åˆ†é˜", type: "exercise" },
                { id: 17, text: "é€™é¤å…ˆåƒèœå†åƒè‚‰", type: "diet" }, { id: 18, text: "æ ¸å¿ƒé‹å‹• 20 ä¸‹", type: "exercise" },
                { id: 19, text: "å–ç„¡ç³–èŒ¶ä»£æ›¿é…’/æœæ±", type: "diet" }, { id: 20, text: "æ—¥è¡Œ 8000 æ­¥", type: "exercise" },
                { id: 21, text: "åˆ†äº«ä¸€å€‹å¥åº·çŸ¥è­˜", type: "life" }, { id: 22, text: "ä¸åƒå®µå¤œ", type: "diet" },
                { id: 23, text: "æ³¢æ¯”è·³ 10 ä¸‹", type: "exercise" }, { id: 24, text: "é‡é«”é‡ä¸¦è¨˜éŒ„", type: "life" },
                { id: 25, text: "å‘è¦ªå‹èªªä¸€å¥å‰ç¥¥è©±", type: "life" },
            ];

            const externalGames = [
                { name: "Exercise Snack", desc: "å¿«é€Ÿé‹å‹•å°éŠæˆ²", url: "https://lukehsiao-yc.github.io/exercise-snack-game/", icon: <Zap size={20} />, color: "bg-orange-100 text-orange-600" },
                { name: "Fat Fat è„‚è‚ªå¤§ä½œæˆ°", desc: "å°æŠ—ç†±é‡å°éŠæˆ²", url: "https://lukehsiao-yc.github.io/fatfat/", icon: <Gamepad2 size={20} />, color: "bg-blue-100 text-blue-600" },
                { name: "Breathing æ·±å‘¼å¸", desc: "æ”¾é¬†èˆ‡ç´“å£“ç·´ç¿’", url: "https://lukehsiao-yc.github.io/breathing/", icon: <Wind size={20} />, color: "bg-green-100 text-green-600" }
            ];

            const [grid, setGrid] = useState(initialGridData);
            const [activeTab, setActiveTab] = useState('bingo');
            const [bossHP, setBossHP] = useState(BOSS_MAX_HP);
            const [isBossHit, setIsBossHit] = useState(false);
            const [showHitEffect, setShowHitEffect] = useState(null); 
            const [inventory, setInventory] = useState([]);
            const [spentPoints, setSpentPoints] = useState(0);
            const [totalScore, setTotalScore] = useState(0);
            const [lines, setLines] = useState(0);
            const [isDrawing, setIsDrawing] = useState(false);
            const [drawResult, setDrawResult] = useState(null);
            const [fortuneResult, setFortuneResult] = useState(null);
            const [isShaking, setIsShaking] = useState(false);
            const [senderName, setSenderName] = useState('');
            const [recipientName, setRecipientName] = useState('');
            const [selectedGreetings, setSelectedGreetings] = useState([]);
            const [selectedMascot, setSelectedMascot] = useState(null);
            const [showGeneratedCard, setShowGeneratedCard] = useState(false);
            const [shareUrl, setShareUrl] = useState('');

            useEffect(() => {
                const savedGrid = localStorage.getItem('cnyBingoGrid_v3');
                if (savedGrid) setGrid(JSON.parse(savedGrid));
                const savedInv = localStorage.getItem('cnyBingoInventory_v3');
                if (savedInv) setInventory(JSON.parse(savedInv));
                const savedSpent = localStorage.getItem('cnyBingoSpent_v3');
                if (savedSpent) setSpentPoints(parseInt(savedSpent));
                if (typeof window !== 'undefined') {
                    if (window.location.protocol === 'file:') {
                        setShareUrl("https://lukehsiao-yc.github.io/2026-cny-bingo/"); // Example URL
                    } else {
                        setShareUrl(window.location.href.split('?')[0]);
                    }
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('cnyBingoGrid_v3', JSON.stringify(grid));
                localStorage.setItem('cnyBingoInventory_v3', JSON.stringify(inventory));
                localStorage.setItem('cnyBingoSpent_v3', spentPoints.toString());
                recalcStats();
            }, [grid, spentPoints]);

            const recalcStats = () => {
                let checkedCount = 0;
                let newLines = 0;
                const isChecked = (i) => grid[i]?.checked;
                for (let i = 0; i < 5; i++) if ([0,1,2,3,4].every(o => isChecked(i*5+o))) newLines++;
                for (let i = 0; i < 5; i++) if ([0,1,2,3,4].every(o => isChecked(i+o*5))) newLines++;
                if ([0,6,12,18,24].every(i => isChecked(i))) newLines++;
                if ([4,8,12,16,20].every(i => isChecked(i))) newLines++;
                grid.forEach(c => { if(c.checked && c.id !== 13) checkedCount++ });
                const score = (checkedCount * 10) + (newLines * 50);
                setTotalScore(score);
                setLines(newLines);
                const damageDealt = (checkedCount * 20) + (newLines * 50);
                setBossHP(Math.max(0, BOSS_MAX_HP - damageDealt));
            };

            const triggerConfetti = () => {
                if(window.confetti) window.confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#fbbf24', '#ef4444', '#ffffff'] });
            };

            const handleTaskClick = (id, e) => {
                if (id === 13) return;
                const cell = grid.find(c => c.id === id);
                if (!cell) return;
                const isCompleting = !cell.checked;
                setGrid(grid.map(c => c.id === id ? { ...c, checked: !c.checked } : c));
                if (isCompleting) {
                    setIsBossHit(true);
                    setTimeout(() => setIsBossHit(false), 500);
                    const rect = e.currentTarget.getBoundingClientRect();
                    setShowHitEffect({ x: rect.left + rect.width/2, y: rect.top, val: 20 });
                    setTimeout(() => setShowHitEffect(null), 800);
                }
            };

            const handleDraw = () => {
                if ((totalScore - spentPoints) < GACHA_COST) return alert("ç©åˆ†ä¸è¶³ï¼å¿«å»æ”»æ“Šå¹´ç¸è³ºå–ç©åˆ†ï¼");
                setSpentPoints(p => p + GACHA_COST);
                setIsDrawing(true);
                setTimeout(() => {
                    const rand = Math.random();
                    let cumulative = 0;
                    let prize = PRIZE_POOL[PRIZE_POOL.length-1];
                    for (let p of PRIZE_POOL) {
                        cumulative += p.chance;
                        if (rand < cumulative) { prize = p; break; }
                    }
                    setInventory(prev => [prize, ...prev]);
                    setDrawResult(prize);
                    setIsDrawing(false);
                    if(prize.rarity === 'SSR') triggerConfetti();
                }, 1500);
            };

            const handleFortune = () => {
                setIsShaking(true);
                setFortuneResult(null);
                setTimeout(() => {
                    setIsShaking(false);
                    setFortuneResult(FORTUNES[Math.floor(Math.random()*FORTUNES.length)]);
                }, 1500);
            };

            const resetData = () => {
                if(confirm("ç¢ºå®šé‡ç½®é€²åº¦ï¼Ÿ(æˆ°åˆ©å“æœƒä¿ç•™)")) {
                    setGrid(initialGridData.map(c => c.id===13 ? {...c, checked:true} : {...c, checked:false}));
                }
            };

            const toggleGreetingSelection = (id) => {
                if (selectedGreetings.includes(id)) {
                    setSelectedGreetings(selectedGreetings.filter(gId => gId !== id));
                } else {
                    if (selectedGreetings.length < 3) {
                        setSelectedGreetings([...selectedGreetings, id]);
                    } else {
                        alert("æœ€å¤šåªèƒ½é¸æ“‡ 3 å€‹å¥åº·å…ƒç´ å–”ï¼");
                    }
                }
            };

            const generateCard = () => {
                if (selectedGreetings.length === 0) {
                    alert("è«‹è‡³å°‘é¸æ“‡ 1 å€‹å¥åº·å…ƒç´ ï¼");
                    return;
                }
                setShowGeneratedCard(true);
            };

            const availablePoints = totalScore - spentPoints;
            const uniqueInv = [...new Map(inventory.map(item => [item.id, item])).values()];

            return (
                <div className="max-w-md mx-auto min-h-screen relative pb-28 overflow-x-hidden shadow-2xl bg-[#fffaf0]">
                    
                    {/* BOSS BATTLE SECTION */}
                    <div className="relative bg-gradient-to-b from-slate-900 to-red-900 text-white p-6 rounded-b-[2rem] shadow-xl z-10 overflow-hidden border-b-4 border-yellow-500">
                        <div className="flex justify-center items-center mb-4 relative mt-2">
                            <div className={`transition-transform duration-100 ${isBossHit ? 'animate-shake-hard brightness-150 sepia' : 'animate-float'}`}>
                                {bossHP > 0 ? (
                                    <div className="text-8xl filter drop-shadow-[0_0_15px_rgba(239,68,68,0.8)]">ğŸ‘¹</div>
                                ) : (
                                    <div className="text-8xl animate-bounce">ğŸ“¦</div>
                                )}
                            </div>
                            {showHitEffect && (
                                <div className="fixed text-4xl font-black text-yellow-400 animate-hit z-50 pointer-events-none" style={{ left: showHitEffect.x, top: showHitEffect.y }}>
                                    -20
                                </div>
                            )}
                        </div>

                        <div className="text-center relative z-10">
                            <h2 className="text-sm font-bold text-red-300 tracking-widest mb-1">BOSS RAID</h2>
                            <h1 className="text-2xl font-black text-white mb-2 flex items-center justify-center gap-2">
                                {bossHP > 0 ? "é«”è„‚è‚ªå¹´ç¸" : "å¹´ç¸å·²æ“Šé€€ï¼"}
                            </h1>
                            <div className="w-full h-4 bg-slate-800 rounded-full overflow-hidden border border-slate-600 relative mb-2 shadow-inner">
                                <div className="h-full bg-gradient-to-r from-red-500 to-yellow-500 transition-all duration-500 ease-out" style={{ width: `${(bossHP / BOSS_MAX_HP) * 100}%` }}></div>
                            </div>
                            <p className="text-xs text-slate-400 flex justify-between">
                                <span>HP: {bossHP}/{BOSS_MAX_HP}</span>
                                <span>{bossHP === 0 ? "çå‹µå·²æ‰è½" : "å®Œæˆä»»å‹™é€ æˆå‚·å®³"}</span>
                            </p>
                        </div>

                        <div className="grid grid-cols-2 gap-4 mt-6 bg-white/10 backdrop-blur-md rounded-xl p-3 border border-white/10">
                            <div className="text-center border-r border-white/10">
                                <div className="text-xs text-yellow-200 mb-1">å¯ç”¨æˆ°åˆ©é»æ•¸</div>
                                <div className="text-2xl font-black text-yellow-400">{availablePoints}</div>
                            </div>
                            <div className="text-center">
                                <div className="text-xs text-yellow-200 mb-1">BINGO é€£ç·š</div>
                                <div className="text-2xl font-black text-yellow-400">{lines}</div>
                            </div>
                        </div>
                    </div>

                    {/* MAIN CONTENT */}
                    <div className="px-4 -mt-4 relative z-20">
                        {/* VIEW: BINGO */}
                        {activeTab === 'bingo' && (
                            <div className="animate-in pt-4">
                                {/* Grid */}
                                <div className="glass-panel p-3 rounded-2xl mb-6">
                                    <div className="grid grid-cols-5 gap-2">
                                        {grid.map((cell) => (
                                            <button 
                                                key={cell.id} 
                                                onClick={(e) => handleTaskClick(cell.id, e)}
                                                className={`
                                                    aspect-square flex flex-col items-center justify-center p-1 rounded-xl transition-all duration-200 relative border
                                                    ${cell.checked 
                                                        ? 'bg-yellow-100 border-yellow-400 text-red-900 shadow-inner' 
                                                        : 'bg-white border-slate-200 text-slate-500 hover:border-red-300 shadow-sm'}
                                                    ${cell.id === 13 ? 'border-yellow-400 bg-yellow-50' : ''}
                                                `}
                                            >
                                                <div className={`mb-1 transition-transform ${cell.checked ? 'scale-110 text-red-700' : ''}`}>
                                                    {getIcon(cell.id, cell.type)}
                                                </div>
                                                <span className="text-[9px] leading-[1.1] font-bold text-center line-clamp-2">
                                                    {cell.text}
                                                </span>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div className="text-center mb-8">
                                    <button onClick={resetData} className="px-6 py-2 rounded-full bg-slate-200 text-slate-500 text-xs font-bold hover:bg-slate-300">
                                        é‡ç½®é€²åº¦
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* VIEW: GAMES (New Independent Tab) */}
                        {activeTab === 'games' && (
                            <div className="animate-in pt-6">
                                <div className="glass-panel p-6 rounded-3xl border-white/50 mb-8">
                                    <h3 className="font-bold text-red-800 mb-6 flex items-center text-lg border-b border-red-100 pb-3">
                                        <Gamepad2 className="mr-2" size={24}/> å¥åº·éŠæˆ²å°å¹«æ‰‹
                                    </h3>
                                    <div className="grid grid-cols-1 gap-4">
                                        {externalGames.map((game, index) => (
                                            <a 
                                                key={index}
                                                href={game.url} 
                                                target="_blank" 
                                                rel="noopener noreferrer"
                                                className="flex items-center p-4 bg-white rounded-xl shadow-md border border-slate-100 hover:shadow-lg hover:border-red-200 transition-all group"
                                            >
                                                <div className={`p-4 rounded-full mr-4 ${game.color} group-hover:scale-110 transition-transform`}>
                                                    {game.icon}
                                                </div>
                                                <div className="flex-1">
                                                    <h4 className="font-bold text-lg text-slate-800">{game.name}</h4>
                                                    <p className="text-sm text-slate-500">{game.desc}</p>
                                                </div>
                                                <ExternalLink size={20} className="text-slate-300 group-hover:text-red-400 transition-colors"/>
                                            </a>
                                        ))}
                                    </div>
                                    <p className="text-center text-xs text-slate-400 mt-6">é»æ“Šä¸Šæ–¹å¡ç‰‡å³å¯é–‹å•Ÿå°æ‡‰çš„äº’å‹•éŠæˆ²</p>
                                </div>
                            </div>
                        )}

                        {/* VIEW: GACHA */}
                        {activeTab === 'gacha' && (
                            <div className="animate-in pt-6">
                                <div className="glass-panel p-6 rounded-3xl text-center border-2 border-yellow-400/30 relative overflow-hidden mb-8">
                                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-red-500 via-yellow-400 to-red-500"></div>
                                    <h3 className="text-2xl font-black golden-text mb-2">é´»é‹å¯¶åº«</h3>
                                    <p className="text-slate-500 text-sm mb-6">æ¶ˆè€— {GACHA_COST} é»æ•¸ï¼Œå¬å–šé¦¬å¹´å®ˆè­·éˆï¼</p>
                                    
                                    {drawResult && !isDrawing ? (
                                        <div className="bg-yellow-50 rounded-2xl p-6 border-2 border-yellow-200 mb-6 zoom-in shadow-inner">
                                            <div className="text-6xl mb-4 animate-float">{drawResult.icon}</div>
                                            <div className="inline-block px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-full mb-2">{drawResult.rarity}</div>
                                            <h4 className="text-xl font-bold text-slate-800">{drawResult.name}</h4>
                                            <p className="text-xs text-slate-500 mt-2">{drawResult.desc}</p>
                                        </div>
                                    ) : (
                                        <div className="h-48 flex items-center justify-center mb-6">
                                            <div className={`text-8xl transition-all ${isDrawing ? 'animate-bounce' : ''}`}>ğŸ</div>
                                        </div>
                                    )}

                                    <button 
                                        onClick={handleDraw} 
                                        disabled={isDrawing || availablePoints < GACHA_COST}
                                        className={`w-full py-4 rounded-2xl font-black text-lg shadow-lg transform transition-all active:scale-95 flex items-center justify-center gap-2
                                            ${availablePoints >= GACHA_COST 
                                                ? 'bg-gradient-to-r from-red-600 to-red-500 text-white shadow-red-500/30' 
                                                : 'bg-slate-200 text-slate-400 cursor-not-allowed'}
                                        `}
                                    >
                                        {isDrawing ? "å¬å–šä¸­..." : <><Sparkles size={20}/> å¬å–šå®ˆè­·éˆ (-{GACHA_COST})</>}
                                    </button>
                                </div>

                                <div className="space-y-3 pb-8">
                                    <h4 className="font-bold text-slate-700 px-2">æˆ‘çš„æ”¶è—</h4>
                                    {uniqueInv.length === 0 ? (
                                        <div className="text-center py-10 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ</div>
                                    ) : (
                                        <div className="grid grid-cols-2 gap-3">
                                            {uniqueInv.map((item, idx) => (
                                                <div key={idx} className={`p-3 rounded-xl border-2 flex items-center gap-3 bg-white ${item.color}`}>
                                                    <span className="text-3xl filter drop-shadow-sm">{item.icon}</span>
                                                    <div className="text-left overflow-hidden">
                                                        <p className="text-[10px] font-black opacity-60 uppercase">{item.rarity}</p>
                                                        <p className="font-bold text-sm truncate text-slate-800">{item.name}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* VIEW: FORTUNE */}
                        {activeTab === 'fortune' && (
                            <div className="animate-in pt-10 text-center">
                                <div className="glass-panel p-8 rounded-3xl border border-red-100 relative">
                                    <div className="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-6 py-2 rounded-full font-bold shadow-lg flex items-center gap-2 whitespace-nowrap">
                                        <Wand2 size={18}/> æ¯æ—¥é‹å‹¢
                                    </div>
                                    
                                    {!fortuneResult ? (
                                        <div className="py-10 cursor-pointer" onClick={handleFortune}>
                                            <div className={`text-8xl mb-8 select-none transition-transform ${isShaking ? 'animate-shake-hard' : ''}`}>ğŸ</div>
                                            <p className="text-slate-500 font-bold mb-6">é»æ“Šç±¤ç­’ï¼Œæ–å‡ºä»Šæ—¥å¥åº·é‹</p>
                                            <button disabled={isShaking} className="px-8 py-3 bg-slate-800 text-white rounded-xl font-bold">
                                                {isShaking ? "æ„Ÿæ‡‰ä¸­..." : "é–‹å§‹æ±‚ç±¤"}
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="zoom-in py-4">
                                            <div className="border-4 border-slate-800 p-1 inline-block rounded-lg mb-6 bg-white shadow-xl transform rotate-1">
                                                <div className="border-2 border-slate-800 px-6 py-10 rounded bg-red-50 min-w-[220px]">
                                                    <div className="text-5xl font-black text-slate-900 mb-4 font-serif">{fortuneResult.type}</div>
                                                    <div className={`text-xl font-bold mb-6 ${fortuneResult.color}`}>{fortuneResult.title}</div>
                                                    <div className="w-full h-px bg-slate-300 mb-6"></div>
                                                    <p className="text-slate-600 font-medium leading-relaxed">{fortuneResult.text}</p>
                                                </div>
                                            </div>
                                            <div>
                                                <button onClick={() => setFortuneResult(null)} className="text-slate-400 underline text-sm">å†æ±‚ä¸€æ”¯</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* VIEW: CARD */}
                        {activeTab === 'card' && (
                            <div className="animate-in pt-6">
                                {!showGeneratedCard ? (
                                    <div className="glass-panel p-6 rounded-3xl border-white/50">
                                        <h3 className="font-bold text-red-800 mb-6 flex items-center text-lg border-b border-red-100 pb-3">
                                            <Edit3 className="mr-2" size={20}/> è³€å¡è¨­è¨ˆå¸«
                                        </h3>
                                        
                                        <div className="space-y-4 mb-8">
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="text-xs font-bold text-slate-400 block mb-1">æˆ‘æ˜¯</label>
                                                    <input type="text" placeholder="ä½ çš„åå­—" value={senderName} onChange={e => setSenderName(e.target.value)} className="w-full p-3 bg-white border border-slate-200 rounded-xl font-bold focus:outline-none focus:ring-2 focus:ring-red-400"/>
                                                </div>
                                                <div>
                                                    <label className="text-xs font-bold text-slate-400 block mb-1">é€çµ¦</label>
                                                    <input type="text" placeholder="è¦ªå‹ç¨±å‘¼" value={recipientName} onChange={e => setRecipientName(e.target.value)} className="w-full p-3 bg-white border border-slate-200 rounded-xl font-bold focus:outline-none focus:ring-2 focus:ring-red-400"/>
                                                </div>
                                            </div>

                                            {/* Share URL Input - Added robustness */}
                                            <div>
                                                <label className="flex items-center text-xs font-bold text-slate-400 block mb-1">
                                                    <QrCode size={12} className="mr-1"/> åˆ†äº«é€£çµ (ç”Ÿæˆ QR Code)
                                                </label>
                                                <input 
                                                    type="text" 
                                                    placeholder="è«‹è¼¸å…¥ç¶²å€ (å¦‚ https://...)" 
                                                    value={shareUrl} 
                                                    onChange={e => setShareUrl(e.target.value)} 
                                                    className="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-xs text-slate-600 focus:outline-none focus:border-red-400"
                                                />
                                                <p className="text-[10px] text-slate-400 mt-1">â€» è‹¥ QR Code é¡¯ç¤ºç•°å¸¸ï¼Œè«‹ç¢ºèªæ­¤æ¬„ä½ç‚ºæœ‰æ•ˆç¶²å€</p>
                                            </div>

                                            {/* Greeting Selection */}
                                            <div className="mb-4">
                                                <label className="text-xs font-bold text-slate-400 block mb-2">å¥åº·ç¥ç¦ (æœ€å¤š3å€‹)</label>
                                                <div className="grid grid-cols-2 gap-2">
                                                    {GREETING_OPTIONS.map((option) => (
                                                        <button key={option.id} onClick={() => toggleGreetingSelection(option.id)} className={`p-2 rounded-lg border flex items-center gap-2 text-left text-xs ${selectedGreetings.includes(option.id) ? 'border-red-500 bg-red-50 text-red-800 ring-1 ring-red-500' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}>
                                                            {option.icon}
                                                            <span>{option.label}</span>
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>

                                            <div>
                                                <label className="text-xs font-bold text-slate-400 block mb-2">è£é£¾å‰ç¥¥ç‰© (ä¾†è‡ªèƒŒåŒ…)</label>
                                                <div className="flex gap-2 overflow-x-auto pb-2">
                                                    <button onClick={() => setSelectedMascot(null)} className={`flex-shrink-0 w-16 h-16 rounded-xl border-2 flex items-center justify-center font-bold text-xs ${selectedMascot === null ? 'border-red-500 bg-red-50 text-red-600' : 'bg-white border-slate-200 text-slate-400'}`}>ç„¡</button>
                                                    {uniqueInv.map(m => (
                                                        <button key={m.id} onClick={() => setSelectedMascot(m)} className={`flex-shrink-0 w-16 h-16 rounded-xl border-2 flex flex-col items-center justify-center ${selectedMascot?.id === m.id ? 'border-red-500 bg-red-50' : 'bg-white border-slate-200'}`}>
                                                            <span className="text-2xl">{m.icon}</span>
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>

                                        <button onClick={generateCard} className="w-full py-4 bg-red-600 text-white rounded-xl font-bold shadow-lg shadow-red-200 active:scale-95 transition-transform flex items-center justify-center gap-2">
                                            <Send size={18}/> ç”Ÿæˆè³€å¡
                                        </button>
                                    </div>
                                ) : (
                                    <div className="zoom-in pb-8">
                                        <div className="bg-gradient-to-br from-red-700 to-red-900 rounded-2xl shadow-2xl overflow-hidden border-[6px] border-yellow-500 relative max-w-sm mx-auto">
                                            <div className="absolute inset-0 opacity-20" style={{backgroundImage: 'radial-gradient(#fbbf24 1px, transparent 1px)', backgroundSize: '16px 16px'}}></div>
                                            <div className="p-8 pb-32 text-center relative z-10 text-white">
                                                
                                                {/* REMOVED: RANDOM FUNNY IMAGE SECTION */}

                                                <h2 className="text-3xl font-black text-yellow-300 mb-1 tracking-wider mt-8">é¦¬å¹´è¡Œå¤§é‹</h2>
                                                <p className="text-red-200/80 text-xs font-mono mb-8 tracking-[0.3em]">HEALTHY & WEALTHY</p>
                                                
                                                <div className="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20 text-left relative">
                                                    {selectedMascot && (
                                                        <div className="absolute -top-4 -right-4 bg-white text-slate-900 p-2 rounded-lg shadow-xl transform rotate-12 border-2 border-yellow-400">
                                                            <div className="text-4xl">{selectedMascot.icon}</div>
                                                        </div>
                                                    )}
                                                    <p className="text-lg font-bold mb-4">To <span className="text-yellow-300 border-b border-yellow-300/50">{recipientName || 'æœ‹å‹'}</span>ï¼š</p>
                                                    
                                                    {/* Keyword */}
                                                    {senderName && (
                                                        <div className="mb-4 bg-red-900/40 p-2 rounded-lg text-left border-l-2 border-yellow-400">
                                                            <p className="text-xs text-red-200 mb-0.5">å°ˆå±¬ 2026 å‘½å®šé—œéµå­—ï¼š</p>
                                                            <p className="text-xl font-bold text-yellow-300">#{getKeyword(senderName)}</p>
                                                        </div>
                                                    )}

                                                    {/* Greetings List */}
                                                    <div className="space-y-4 mb-6">
                                                        {selectedGreetings.map(id => {
                                                            const item = GREETING_OPTIONS.find(g => g.id === id);
                                                            return item ? (
                                                                <div key={id} className="flex gap-3 items-start">
                                                                    <div className="mt-1 text-yellow-400 flex-shrink-0">{item.icon}</div>
                                                                    <div>
                                                                        <p className="font-bold text-white text-lg">{item.blessing.split('ï¼Œ')[0]}ï¼Œ</p>
                                                                        <p className="text-red-100">{item.blessing.split('ï¼Œ')[1]}</p>
                                                                    </div>
                                                                </div>
                                                            ) : null;
                                                        })}
                                                    </div>

                                                    <div className="flex items-center gap-3 mt-4 pt-4 border-t border-white/10">
                                                        <div className="bg-white p-1 rounded">
                                                            <img 
                                                                src={`https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(shareUrl)}`} 
                                                                className="w-12 h-12"
                                                                onError={(e) => { e.target.style.display='none'; }} 
                                                            />
                                                        </div>
                                                        <div>
                                                            <p className="text-[10px] text-yellow-200 uppercase">Challenge me</p>
                                                            <p className="text-sm font-bold">æƒæåŠ å…¥å¥åº·æŒ‘æˆ°</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="absolute bottom-4 w-full text-center text-[10px] text-white/40">è•­å®‡è¶…é†«å¸« é™ªå¤§å®¶ä¸€èµ·å¥åº·éæ–°å¹´</div>
                                        </div>
                                        <div className="flex gap-4 mt-6 justify-center">
                                            <button onClick={() => setShowGeneratedCard(false)} className="px-6 py-3 rounded-full bg-white text-slate-600 font-bold shadow hover:bg-slate-50">ä¿®æ”¹</button>
                                            <button onClick={() => alert("è«‹æˆªåœ–åˆ†äº«ï¼")} className="px-6 py-3 rounded-full bg-slate-800 text-white font-bold shadow hover:bg-slate-700">ä¿å­˜æˆªåœ–</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* BOTTOM NAV - Updated Layout */}
                    <div className="fixed bottom-4 left-1/2 transform -translate-x-1/2 w-[95%] max-w-md bg-slate-900/95 backdrop-blur-md text-white rounded-2xl shadow-2xl z-50 flex justify-between items-center py-2 px-6 border border-white/10">
                        <button onClick={() => setActiveTab('bingo')} className={`flex flex-col items-center gap-1 py-1 px-1 transition-all ${activeTab === 'bingo' ? 'text-yellow-400 scale-105' : 'text-slate-400 hover:text-white'}`}>
                            <Sword size={20} strokeWidth={2.5}/>
                            <span className="text-sm font-bold">æˆ°é¬¥</span>
                        </button>
                        <button onClick={() => setActiveTab('games')} className={`flex flex-col items-center gap-1 py-1 px-1 transition-all ${activeTab === 'games' ? 'text-yellow-400 scale-105' : 'text-slate-400 hover:text-white'}`}>
                            <Gamepad2 size={20} strokeWidth={2.5}/>
                            <span className="text-sm font-bold">éŠæˆ²</span>
                        </button>
                        <button onClick={() => setActiveTab('gacha')} className={`flex flex-col items-center gap-1 py-1 px-1 transition-all ${activeTab === 'gacha' ? 'text-yellow-400 scale-105' : 'text-slate-400 hover:text-white'}`}>
                            <Gift size={20} strokeWidth={2.5}/>
                            <span className="text-sm font-bold">å¯¶åº«</span>
                        </button>
                        <button onClick={() => setActiveTab('fortune')} className={`flex flex-col items-center gap-1 py-1 px-1 transition-all ${activeTab === 'fortune' ? 'text-yellow-400 scale-105' : 'text-slate-400 hover:text-white'}`}>
                            <Wand2 size={20} strokeWidth={2.5}/>
                            <span className="text-sm font-bold">éˆç±¤</span>
                        </button>
                        <button onClick={() => setActiveTab('card')} className={`flex flex-col items-center gap-1 py-1 px-1 transition-all ${activeTab === 'card' ? 'text-yellow-400 scale-105' : 'text-slate-400 hover:text-white'}`}>
                            <Scroll size={20} strokeWidth={2.5}/>
                            <span className="text-sm font-bold">è³€å¡</span>
                        </button>
                    </div>

                    <div className="text-center pb-24 pt-10 text-red-900/40 text-xs font-bold">
                        è•­å®‡è¶…é†«å¸«è£½ä½œ ä¸€èµ·å¥åº·å¿«æ¨‚æ¯ä¸€å¤©
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BingoGame />);
    </script>
</body>
</html>
