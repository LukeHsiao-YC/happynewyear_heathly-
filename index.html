import React, { useState, useEffect } from 'react';
import { Trophy, Flame, Droplets, Moon, Activity, Utensils, RotateCcw, Share2, Gamepad2, Wind, Zap, ExternalLink, Gift, Dna, Star, Scroll, Send, Check, Edit3, Heart, Shuffle, MousePointer2, Bot, X, Sparkles, QrCode } from 'lucide-react';

// Helper function to render icons based on ID and Type
const getIcon = (id, type) => {
  if (id === 1 || id === 19) return <Droplets size={16} />; // Water/Tea
  if (id === 8) return <Flame size={16} />; // Housework
  if (id === 10 || id === 22) return <Moon size={16} />; // Sleep
  if (id === 21) return <Share2 size={16} />; // Share
  if (id === 13) return <Trophy size={20} />; // Center Trophy
  if (id === 25) return <Trophy size={16} />; // Greeting Trophy
  
  switch (type) {
    case 'diet': return <Utensils size={16} />;
    case 'exercise': return <Activity size={16} />;
    case 'life': return <Activity size={16} />;
    default: return <Activity size={16} />;
  }
};

// Gacha Prize Pool
const PRIZE_POOL = [
  { id: 'p1', name: 'é»ƒé‡‘è¬å…©é¦¬', rarity: 'SSR', chance: 0.05, icon: 'ğŸ', color: 'text-yellow-500 bg-yellow-100', desc: 'é¦¬å¹´è¡Œå¤§é‹ï¼é‹æ°£çˆ†æ£šï¼' },
  { id: 'p2', name: 'åƒé‡Œèµ¤å…”é¦¬', rarity: 'SR', chance: 0.15, icon: 'ğŸ´', color: 'text-red-600 bg-red-100', desc: 'æ´»åŠ›å……æ²›ï¼Œæ—¥è¡Œåƒé‡Œã€‚' },
  { id: 'p3', name: 'å¤¢å¹»ç¨è§’ç¸', rarity: 'SR', chance: 0.15, icon: 'ğŸ¦„', color: 'text-purple-600 bg-purple-100', desc: 'å„ªé›…è¿·äººï¼Œé­…åŠ›å››å°„ã€‚' },
  { id: 'p4', name: 'ç¿ ç‰ç™½èœé¦¬', rarity: 'R', chance: 0.25, icon: 'ğŸ¥¬', color: 'text-green-600 bg-green-100', desc: 'é£²é£Ÿå‡è¡¡ï¼Œè…¸èƒƒå¥åº·ã€‚' },
  { id: 'p5', name: 'å¿«æ¨‚æ–æ–é¦¬', rarity: 'N', chance: 0.40, icon: 'ğŸ ', color: 'text-amber-700 bg-amber-100', desc: 'ç«¥å¿ƒæœªæ³¯ï¼Œå¤©å¤©é–‹å¿ƒã€‚' },
];

// Greeting Card Options
const GREETING_OPTIONS = [
  { id: 'g1', label: 'å¤šå–æ°´', icon: <Droplets size={18}/>, blessing: 'è²¡æºæ»¾æ»¾ä¼¼æµæ°´ï¼Œçš®è†šæ°´å«©åˆQå½ˆï¼' },
  { id: 'g2', label: 'å¤šé‹å‹•', icon: <Activity size={18}/>, blessing: 'æ´»åŠ›å……æ²›åƒé‡é¦¬ï¼Œèº«æç·Šå¯¦äººäººèª‡ï¼' },
  { id: 'g3', label: 'å°‘åƒç³–', icon: <Utensils size={18}/>, blessing: 'ç”œèœœåœ¨å¿ƒä¸åœ¨èº«ï¼Œè¼•ç›ˆçªˆçª•éå¥½å¹´ï¼' },
  { id: 'g4', label: 'ç¡é£½é£½', icon: <Moon size={18}/>, blessing: 'ç¡å¾—å¥½äººä¸è€ï¼Œå®¹å…‰ç…¥ç™¼æ°£è‰²å¥½ï¼' },
  { id: 'g5', label: 'åƒè”¬èœ', icon: <Utensils size={18}/>, blessing: 'è…¸é“é †æš¢æ²’ç…©æƒ±ï¼Œå¥åº·é•·å£½åƒåˆ°è€ï¼' },
  { id: 'g6', label: 'å¥½å¿ƒæƒ…', icon: <Heart size={18}/>, blessing: 'ç¬‘å£å¸¸é–‹å¥½é‹ä¾†ï¼Œç…©æƒ±å£“åŠ›å…¨æ‹‹é–‹ï¼' },
];

const GACHA_COST = 30; // Updated Cost

const BingoGame = () => {
  // 2026 Horse Year Theme Colors: Red, Gold, Orange
  const initialGridData = [
    { id: 1, text: "é¤å‰å– 500cc æ°´", type: "diet" },
    { id: 2, text: "åŸåœ°é–‹åˆè·³ 50 ä¸‹", type: "exercise" },
    { id: 3, text: "é€™é¤åªåƒä¸ƒåˆ†é£½", type: "diet" },
    { id: 4, text: "é£¯å¾Œæ•£æ­¥ 15 åˆ†é˜", type: "exercise" },
    { id: 5, text: "æ‹’çµ•ä¸€æ¯å«ç³–é£²æ–™", type: "diet" },

    { id: 6, text: "æ·±è¹² 20 ä¸‹", type: "exercise" },
    { id: 7, text: "åƒä¸€ç›¤æ·±ç¶ è‰²è”¬èœ", type: "diet" },
    { id: 8, text: "å¹«å¿™åšå®¶äº‹ 20 åˆ†é˜", type: "life" },
    { id: 9, text: "å®Œå…¨ä¸æ²¾é†¬æ–™åƒä¸€é¤", type: "diet" },
    { id: 10, text: "ç¡æ»¿ 7 å°æ™‚", type: "life" },

    { id: 11, text: "å¹³æ¿æ”¯æ’ 1 åˆ†é˜", type: "exercise" },
    { id: 12, text: "çˆ¬æ¨“æ¢¯ä»£æ›¿é›»æ¢¯", type: "exercise" },
    { id: 13, text: "é¦¬å¹´å¤§å‰ (å…è²»æ ¼)", type: "free", checked: true },
    { id: 14, text: "æ°´æœä»£æ›¿é¤…ä¹¾é›¶é£Ÿ", type: "diet" },
    { id: 15, text: "ç«™è‘—æ‰“ç‰Œ/èŠå¤© 1 å±€", type: "life" },

    { id: 16, text: "åšä¼¸å±•æ“ 10 åˆ†é˜", type: "exercise" },
    { id: 17, text: "é€™é¤å…ˆåƒèœå†åƒè‚‰", type: "diet" },
    { id: 18, text: "æ ¸å¿ƒé‹å‹• (ä»°è‡¥èµ·å) 20ä¸‹", type: "exercise" },
    { id: 19, text: "å–ç„¡ç³–èŒ¶ä»£æ›¿é…’/æœæ±", type: "diet" },
    { id: 20, text: "æ—¥è¡Œ 8000 æ­¥", type: "exercise" },

    { id: 21, text: "åˆ†äº«ä¸€å€‹å¥åº·çŸ¥è­˜", type: "life" },
    { id: 22, text: "ä¸åƒå®µå¤œ (9é»å¾Œç¦é£Ÿ)", type: "diet" },
    { id: 23, text: "æ³¢æ¯”è·³ (Burpees) 10 ä¸‹", type: "exercise" },
    { id: 24, text: "é‡é«”é‡ä¸¦è¨˜éŒ„", type: "life" },
    { id: 25, text: "å‘è¦ªå‹èªªä¸€å¥å‰ç¥¥è©±", type: "life" },
  ];

  const externalGames = [
    { 
      name: "Exercise Snack", 
      desc: "å¿«é€Ÿé‹å‹•å°éŠæˆ²",
      url: "https://lukehsiao-yc.github.io/exercise-snack-game/", 
      icon: <Zap size={20} />, 
      color: "bg-orange-100 text-orange-600" 
    },
    { 
      name: "Fat Fat è„‚è‚ªå¤§ä½œæˆ°", 
      desc: "å°æŠ—ç†±é‡å°éŠæˆ²",
      url: "https://lukehsiao-yc.github.io/fatfat/", 
      icon: <Gamepad2 size={20} />, 
      color: "bg-blue-100 text-blue-600" 
    },
    { 
      name: "Breathing æ·±å‘¼å¸", 
      desc: "æ”¾é¬†èˆ‡ç´“å£“ç·´ç¿’",
      url: "https://lukehsiao-yc.github.io/breathing/", 
      icon: <Wind size={20} />, 
      color: "bg-green-100 text-green-600" 
    }
  ];

  const [grid, setGrid] = useState(initialGridData);
  const [lines, setLines] = useState(0);
  const [totalScore, setTotalScore] = useState(0);
  
  // Navigation State
  const [activeTab, setActiveTab] = useState('bingo'); // 'bingo', 'gacha', 'card'
  const [selectionMode, setSelectionMode] = useState('manual'); // 'manual', 'auto'
  
  // Auto Selection State
  const [randomTask, setRandomTask] = useState(null);
  const [showTaskModal, setShowTaskModal] = useState(false);

  // Gacha States
  const [spentPoints, setSpentPoints] = useState(0);
  const [inventory, setInventory] = useState([]);
  const [drawResult, setDrawResult] = useState(null);
  const [isDrawing, setIsDrawing] = useState(false);

  // Card Creator States
  const [senderName, setSenderName] = useState('');
  const [recipientName, setRecipientName] = useState('');
  const [selectedGreetings, setSelectedGreetings] = useState([]);
  const [selectedMascot, setSelectedMascot] = useState(null);
  const [showGeneratedCard, setShowGeneratedCard] = useState(false);
  const [shareUrl, setShareUrl] = useState(''); // New: URL to share

  // Load from local storage on mount
  useEffect(() => {
    try {
      const savedGrid = localStorage.getItem('cnyBingoGrid_v2'); 
      if (savedGrid) setGrid(JSON.parse(savedGrid));
      
      const savedSpent = localStorage.getItem('cnyBingoSpent_v2');
      if (savedSpent) setSpentPoints(parseInt(savedSpent));

      const savedInventory = localStorage.getItem('cnyBingoInventory_v2');
      if (savedInventory) setInventory(JSON.parse(savedInventory));
      
      // Init Share URL (Cleaned up for GitHub Pages sharing)
      // Removes query params like ?fbclid=... to keep QR code clean
      if (typeof window !== 'undefined') {
        const cleanUrl = window.location.origin + window.location.pathname;
        setShareUrl(cleanUrl);
      }
      
    } catch (e) {
      console.error("Failed to load saved game:", e);
      setGrid(initialGridData);
    }
  }, []);

  // Save to local storage on change
  useEffect(() => {
    try {
      localStorage.setItem('cnyBingoGrid_v2', JSON.stringify(grid));
      localStorage.setItem('cnyBingoSpent_v2', spentPoints.toString());
      localStorage.setItem('cnyBingoInventory_v2', JSON.stringify(inventory));
      checkWinConditions();
    } catch (e) {
      console.error("Failed to save game:", e);
    }
  }, [grid, spentPoints, inventory]);

  // Core Game Logic
  const toggleCell = (id) => {
    if (id === 13) return; 
    setGrid(grid.map(cell => 
      cell.id === id ? { ...cell, checked: !cell.checked } : cell
    ));
  };

  const handleGridClick = (id) => {
    if (selectionMode === 'auto') {
      alert("ç›®å‰æ˜¯ã€Œé›»è…¦é¸æ“‡æ¨¡å¼ã€ï¼è«‹é»æ“Šä¸‹æ–¹çš„ã€ŒğŸ”® é›»è…¦å¹«æˆ‘é¸ã€æŒ‰éˆ•ä¾†æŠ½å–ä»»å‹™ã€‚");
      return;
    }
    toggleCell(id);
  };

  const pickRandomTask = () => {
    const availableTasks = grid.filter(cell => !cell.checked && cell.id !== 13);
    
    if (availableTasks.length === 0) {
      alert("å¤ªå²å®³äº†ï¼æ‰€æœ‰ä»»å‹™éƒ½å·²ç¶“å®Œæˆäº†ï¼");
      return;
    }

    const randomIndex = Math.floor(Math.random() * availableTasks.length);
    setRandomTask(availableTasks[randomIndex]);
    setShowTaskModal(true);
  };

  const completeRandomTask = () => {
    if (randomTask) {
      setGrid(grid.map(cell => 
        cell.id === randomTask.id ? { ...cell, checked: true } : cell
      ));
      setShowTaskModal(false);
      setRandomTask(null);
    }
  };

  const checkWinConditions = () => {
    let newLines = 0;
    let checkedCount = 0;
    const isChecked = (index) => grid[index]?.checked;

    for (let i = 0; i < 5; i++) {
      if ([0, 1, 2, 3, 4].every(offset => isChecked(i * 5 + offset))) newLines++;
    }
    for (let i = 0; i < 5; i++) {
      if ([0, 1, 2, 3, 4].every(offset => isChecked(i + offset * 5))) newLines++;
    }
    if ([0, 6, 12, 18, 24].every(index => isChecked(index))) newLines++;
    if ([4, 8, 12, 16, 20].every(index => isChecked(index))) newLines++;

    grid.forEach(cell => {
      if(cell.checked && cell.id !== 13) checkedCount++;
    });

    setLines(newLines);
    setTotalScore((checkedCount * 10) + (newLines * 50));
  };

  const handleDraw = () => {
    const cost = GACHA_COST;
    const availablePoints = totalScore - spentPoints;

    if (availablePoints < cost) {
      alert("ç©åˆ†ä¸è¶³ï¼å¿«å»å®Œæˆæ›´å¤šå¥åº·ä»»å‹™å§ï¼");
      return;
    }

    setIsDrawing(true);
    setSpentPoints(prev => prev + cost);

    setTimeout(() => {
      const rand = Math.random();
      let cumulativeChance = 0;
      let prize = PRIZE_POOL[PRIZE_POOL.length - 1];

      for (let p of PRIZE_POOL) {
        cumulativeChance += p.chance;
        if (rand < cumulativeChance) {
          prize = p;
          break;
        }
      }

      const newPrize = { ...prize, obtainedAt: new Date().toISOString() };
      setInventory(prev => [newPrize, ...prev]);
      setDrawResult(newPrize);
      setIsDrawing(false);
    }, 1500);
  };

  const resetGame = () => {
    if(window.confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰é€²åº¦å—ï¼Ÿï¼ˆæˆ°åˆ©å“æœƒä¿ç•™ï¼‰")) {
      const reset = initialGridData.map(cell => 
        cell.id === 13 ? { ...cell, checked: true } : { ...cell, checked: false }
      );
      setGrid(reset);
    }
  };

  // Greeting Card Logic
  const toggleGreetingSelection = (id) => {
    if (selectedGreetings.includes(id)) {
      setSelectedGreetings(selectedGreetings.filter(gId => gId !== id));
    } else {
      if (selectedGreetings.length < 3) {
        setSelectedGreetings([...selectedGreetings, id]);
      } else {
        alert("æœ€å¤šåªèƒ½é¸æ“‡ 3 å€‹å¥åº·å…ƒç´ å–”ï¼");
      }
    }
  };
  
  const uniqueInventory = inventory.reduce((acc, current) => {
    const x = acc.find(item => item.id === current.id);
    return !x ? acc.concat([current]) : acc;
  }, []);

  const generateCard = () => {
    if (selectedGreetings.length === 0) {
      alert("è«‹è‡³å°‘é¸æ“‡ 1 å€‹å¥åº·å…ƒç´ ï¼");
      return;
    }
    setShowGeneratedCard(true);
  };

  const availablePoints = totalScore - spentPoints;

  return (
    <div className="min-h-screen bg-red-50 text-slate-800 font-sans pb-24 relative">
      {/* Header */}
      <div className="bg-red-600 text-white p-6 shadow-lg rounded-b-3xl mb-6 relative overflow-hidden">
        <div className="absolute top-0 right-0 opacity-10 transform translate-x-10 -translate-y-10">
          <Trophy size={150} />
        </div>
        <h1 className="text-3xl font-bold mb-2 text-center">2026 è¬é¦¬å¥”é¨°</h1>
        <h2 className="text-xl font-medium text-center text-yellow-300">å¥åº·ä¸è…«è³“æœå¤§æŒ‘æˆ°</h2>
        
        <div className="flex justify-center mt-6 gap-6">
          <div className="text-center">
            <p className="text-xs text-red-200 uppercase tracking-wider">å¯ç”¨ç©åˆ†</p>
            <p className="text-4xl font-bold text-white">{availablePoints}</p>
          </div>
          <div className="w-px bg-red-400 h-12"></div>
          <div className="text-center">
            <p className="text-xs text-red-200 uppercase tracking-wider">ç¸½é€£ç·š</p>
            <p className="text-4xl font-bold text-yellow-300">{lines}</p>
          </div>
        </div>
      </div>

      {/* Main Content Area */}
      <div className="px-4 max-w-lg mx-auto">
        
        {/* VIEW: BINGO */}
        {activeTab === 'bingo' && (
          <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
            
            {/* Mode Switcher */}
            <div className="flex bg-red-100 p-1 rounded-xl mb-4">
              <button 
                onClick={() => setSelectionMode('manual')}
                className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-sm font-bold transition-all ${
                  selectionMode === 'manual' 
                    ? 'bg-white text-red-600 shadow-sm' 
                    : 'text-red-400 hover:bg-red-200/50'
                }`}
              >
                <MousePointer2 size={16}/> è‡ªé¸æ¨¡å¼
              </button>
              <button 
                onClick={() => setSelectionMode('auto')}
                className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-sm font-bold transition-all ${
                  selectionMode === 'auto' 
                    ? 'bg-white text-red-600 shadow-sm' 
                    : 'text-red-400 hover:bg-red-200/50'
                }`}
              >
                <Bot size={16}/> é›»è…¦æ¨¡å¼
              </button>
            </div>

            {/* Grid Container */}
            <div className={`grid grid-cols-5 gap-2 mb-6 ${selectionMode === 'auto' ? 'opacity-90' : ''}`}>
              {grid.map((cell) => (
                <button
                  key={cell.id}
                  onClick={() => handleGridClick(cell.id)}
                  className={`
                    aspect-square flex flex-col items-center justify-center p-1 rounded-lg shadow-sm transition-all duration-200 relative
                    ${cell.checked 
                      ? 'bg-yellow-400 text-red-900 transform scale-95 ring-2 ring-red-500' 
                      : selectionMode === 'auto' && cell.id !== 13 
                        ? 'bg-slate-100 text-slate-400 cursor-not-allowed border-slate-200'
                        : 'bg-white hover:bg-red-50 text-slate-600'}
                    ${cell.id === 13 ? 'bg-yellow-200 ring-2 ring-yellow-500' : ''}
                  `}
                >
                  <div className={`mb-1 ${cell.checked ? 'text-red-800' : 'text-slate-400'}`}>
                    {getIcon(cell.id, cell.type)}
                  </div>
                  <span className="text-[10px] leading-tight text-center font-medium overflow-hidden">
                    {cell.text}
                  </span>
                </button>
              ))}
            </div>

            {/* Auto Mode Control */}
            {selectionMode === 'auto' && (
              <div className="mb-8 p-4 bg-red-50 border border-red-200 rounded-xl text-center animate-in zoom-in duration-300">
                <p className="text-sm text-red-800 mb-3 font-medium">ä¸çŸ¥é“è©²åšä»€éº¼ï¼Ÿè®“é›»è…¦å¹«ä½ æ±ºå®šï¼</p>
                <button 
                  onClick={pickRandomTask}
                  className="w-full py-3 bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-red-200 hover:scale-[1.02] active:scale-95 transition-all"
                >
                  <Shuffle size={20}/> ğŸ”® é›»è…¦å¹«æˆ‘é¸
                </button>
              </div>
            )}

            {/* External Games */}
            <div className="mb-8">
              <h3 className="font-bold text-red-800 mb-3 flex items-center px-1">
                <Gamepad2 className="mr-2" size={20}/> å¥åº·éŠæˆ²å°å¹«æ‰‹
              </h3>
              <div className="grid grid-cols-1 gap-3">
                {externalGames.map((game, index) => (
                  <a 
                    key={index}
                    href={game.url} 
                    target="_blank" 
                    rel="noopener noreferrer"
                    className="flex items-center p-4 bg-white rounded-xl shadow-sm border border-slate-100 hover:shadow-md hover:border-red-100 transition-all group"
                  >
                    <div className={`p-3 rounded-full mr-4 ${game.color} group-hover:scale-110 transition-transform`}>
                      {game.icon}
                    </div>
                    <div className="flex-1">
                      <h4 className="font-bold text-slate-800">{game.name}</h4>
                      <p className="text-xs text-slate-500">{game.desc}</p>
                    </div>
                    <ExternalLink size={16} className="text-slate-300 group-hover:text-red-400 transition-colors"/>
                  </a>
                ))}
              </div>
            </div>

            <div className="flex justify-center mb-8">
                <button 
                  onClick={resetGame}
                  className="flex items-center gap-2 px-6 py-3 bg-slate-200 text-slate-600 rounded-full font-medium hover:bg-slate-300 transition-colors"
                >
                  <RotateCcw size={18} /> é‡ç½®/æ–°çš„ä¸€å¤©
                </button>
            </div>
          </div>
        )}

        {/* VIEW: GACHA */}
        {activeTab === 'gacha' && (
          <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div className="bg-white rounded-2xl shadow-sm p-6 text-center border-2 border-red-100 mb-8 relative overflow-hidden">
               <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-red-400 via-yellow-400 to-red-400"></div>
               
               <Gift className="mx-auto text-red-500 mb-4" size={48} />
               <h3 className="text-xl font-bold text-red-800 mb-2">é´»é‹æŠ½ç±¤ç­’</h3>
               <p className="text-slate-500 text-sm mb-6">æ¶ˆè€— {GACHA_COST} ç©åˆ†ï¼ŒæŠ½å–é¦¬å¹´é™å®šå‰ç¥¥ç‰©ï¼</p>
               
               {drawResult && !isDrawing && (
                 <div className="mb-6 p-4 bg-yellow-50 rounded-xl border border-yellow-200 animate-in zoom-in duration-300">
                    <p className="text-xs text-yellow-600 font-bold mb-1">æ­å–œç²å¾—</p>
                    <div className="text-4xl mb-2">{drawResult.icon}</div>
                    <div className={`inline-block px-2 py-0.5 rounded text-xs font-bold mb-2 ${
                        drawResult.rarity === 'SSR' ? 'bg-yellow-500 text-white' : 
                        drawResult.rarity === 'SR' ? 'bg-red-500 text-white' : 
                        drawResult.rarity === 'R' ? 'bg-green-500 text-white' : 
                        'bg-slate-400 text-white'
                    }`}>
                        {drawResult.rarity}
                    </div>
                    <h4 className="font-bold text-lg text-slate-800">{drawResult.name}</h4>
                    <p className="text-xs text-slate-500 mt-1">{drawResult.desc}</p>
                 </div>
               )}

               <button 
                 onClick={handleDraw}
                 disabled={isDrawing || availablePoints < GACHA_COST}
                 className={`w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 transition-all ${
                   isDrawing ? 'bg-slate-100 text-slate-400' :
                   availablePoints >= GACHA_COST ? 'bg-gradient-to-r from-red-500 to-red-600 text-white shadow-lg shadow-red-200 active:scale-95' :
                   'bg-slate-200 text-slate-400 cursor-not-allowed'
                 }`}
               >
                 {isDrawing ? (
                   <>æ­£åœ¨æ–ç±¤...</>
                 ) : (
                   <><Dna size={20}/> è©¦è©¦æ‰‹æ°£ (-{GACHA_COST}åˆ†)</>
                 )}
               </button>
            </div>

            <div className="mb-8">
              <h3 className="font-bold text-slate-800 mb-3 flex items-center px-1">
                <Star className="mr-2 text-yellow-500" size={20}/> æˆ‘çš„æˆ°åˆ©å“ ({inventory.length})
              </h3>
              {inventory.length === 0 ? (
                <div className="text-center py-8 text-slate-400 bg-slate-50 rounded-xl border border-dashed border-slate-200">
                  å°šæœªç²å¾—ä»»ä½•å‰ç¥¥ç‰©
                </div>
              ) : (
                <div className="grid grid-cols-2 gap-3">
                  {inventory.map((item, idx) => (
                    <div key={idx} className={`p-3 rounded-xl border flex items-center gap-3 ${item.color} border-white shadow-sm`}>
                      <span className="text-2xl">{item.icon}</span>
                      <div className="text-left overflow-hidden">
                        <p className="text-xs font-bold opacity-70">{item.rarity}</p>
                        <p className="font-bold text-sm truncate">{item.name}</p>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

        {/* VIEW: CARD CREATOR */}
        {activeTab === 'card' && (
          <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
            {!showGeneratedCard ? (
              <div className="bg-white rounded-2xl shadow-sm p-6 border-2 border-red-100">
                <h3 className="font-bold text-red-800 mb-4 flex items-center text-lg">
                  <Edit3 className="mr-2" size={20}/> è£½ä½œå¥åº·è³€å¹´å¡
                </h3>
                
                {/* Inputs */}
                <div className="space-y-4 mb-6">
                  <div>
                    <label className="block text-xs font-bold text-slate-500 mb-1">æˆ‘æ˜¯ (å¯„ä»¶äºº)</label>
                    <input 
                      type="text" 
                      placeholder="ä¾‹å¦‚ï¼šå°æ˜"
                      value={senderName}
                      onChange={(e) => setSenderName(e.target.value)}
                      className="w-full p-2 border border-slate-200 rounded-lg focus:outline-none focus:border-red-400"
                    />
                  </div>
                  <div>
                    <label className="block text-xs font-bold text-slate-500 mb-1">æƒ³é€çµ¦ (æ”¶ä»¶äºº)</label>
                    <input 
                      type="text" 
                      placeholder="ä¾‹å¦‚ï¼šé˜¿å…¬ã€åª½åª½"
                      value={recipientName}
                      onChange={(e) => setRecipientName(e.target.value)}
                      className="w-full p-2 border border-slate-200 rounded-lg focus:outline-none focus:border-red-400"
                    />
                  </div>
                  {/* Share Link Input */}
                  <div>
                    <label className="flex items-center text-xs font-bold text-slate-500 mb-1">
                      <QrCode size={14} className="mr-1"/> åˆ†äº«é€£çµ (ç”Ÿæˆ QR Code)
                    </label>
                    <input 
                      type="text" 
                      placeholder="https://..."
                      value={shareUrl}
                      onChange={(e) => setShareUrl(e.target.value)}
                      className="w-full p-2 border border-slate-200 rounded-lg focus:outline-none focus:border-red-400 text-xs text-slate-600"
                    />
                  </div>
                </div>

                {/* Greeting Selection */}
                <div className="mb-6">
                  <label className="block text-xs font-bold text-slate-500 mb-2">
                    1. é¸æ“‡ 1~3 å€‹å¥åº·ç¥ç¦ ({selectedGreetings.length}/3)
                  </label>
                  <div className="grid grid-cols-2 gap-3">
                    {GREETING_OPTIONS.map((option) => (
                      <button
                        key={option.id}
                        onClick={() => toggleGreetingSelection(option.id)}
                        className={`p-3 rounded-xl border flex items-center gap-2 transition-all text-left ${
                          selectedGreetings.includes(option.id)
                            ? 'border-red-500 bg-red-50 text-red-800 ring-1 ring-red-500'
                            : 'border-slate-100 bg-slate-50 text-slate-600 hover:bg-slate-100'
                        }`}
                      >
                        <div className={`${selectedGreetings.includes(option.id) ? 'text-red-500' : 'text-slate-400'}`}>
                          {option.icon}
                        </div>
                        <span className="text-sm font-bold">{option.label}</span>
                        {selectedGreetings.includes(option.id) && <Check size={16} className="ml-auto text-red-500"/>}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Mascot Selection */}
                <div className="mb-8">
                  <label className="block text-xs font-bold text-slate-500 mb-2">
                    2. é¸æ“‡å‰ç¥¥ç‰©è£é£¾ (ä¾†è‡ªæ‚¨çš„æˆ°åˆ©å“)
                  </label>
                  {uniqueInventory.length === 0 ? (
                    <div className="p-4 bg-slate-50 border border-dashed border-slate-200 rounded-xl text-center text-sm text-slate-500">
                      <p className="mb-2">æ‚¨çš„èƒŒåŒ…æ˜¯ç©ºçš„ ğŸ˜±</p>
                      <button onClick={() => setActiveTab('gacha')} className="text-red-500 underline font-bold">å¿«å»æŠ½å¹¾éš»å‰ç¥¥ç‰©å§ï¼</button>
                    </div>
                  ) : (
                    <div className="grid grid-cols-3 gap-2">
                      <button
                        onClick={() => setSelectedMascot(null)}
                        className={`p-2 rounded-xl border flex flex-col items-center justify-center gap-1 transition-all min-h-[80px] ${
                          selectedMascot === null
                            ? 'border-red-500 bg-red-50 text-red-800 ring-1 ring-red-500'
                            : 'border-slate-100 bg-white text-slate-400 hover:bg-slate-50'
                        }`}
                      >
                         <span className="text-xs font-bold">ä¸ä½¿ç”¨</span>
                      </button>
                      {uniqueInventory.map((item) => (
                        <button
                          key={item.id}
                          onClick={() => setSelectedMascot(item)}
                          className={`p-2 rounded-xl border flex flex-col items-center gap-1 transition-all ${
                            selectedMascot?.id === item.id
                              ? 'border-red-500 bg-red-50 text-red-800 ring-1 ring-red-500'
                              : 'border-slate-100 bg-white text-slate-600 hover:bg-slate-50'
                          }`}
                        >
                          <span className="text-2xl">{item.icon}</span>
                          <span className="text-[10px] font-bold truncate w-full text-center">{item.name}</span>
                        </button>
                      ))}
                    </div>
                  )}
                </div>

                <button 
                  onClick={generateCard}
                  className="w-full py-3 bg-red-600 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-red-200 hover:bg-red-700 active:scale-95 transition-all"
                >
                  <Send size={18}/> ç”Ÿæˆè³€å¡
                </button>
              </div>
            ) : (
              // Generated Card View
              <div className="animate-in zoom-in duration-300 mb-8">
                <div className="bg-gradient-to-b from-red-600 to-red-800 rounded-2xl shadow-xl overflow-hidden border-4 border-yellow-500 relative">
                  {/* Decorative Patterns */}
                  <div className="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none" 
                       style={{backgroundImage: 'radial-gradient(circle, #fbbf24 2px, transparent 2.5px)', backgroundSize: '20px 20px'}}>
                  </div>
                  
                  {/* Card Content */}
                  <div className="p-8 pb-32 text-center relative z-10 text-white">
                    <div className="w-16 h-16 bg-yellow-400 rounded-full flex items-center justify-center mx-auto mb-4 text-red-800 shadow-lg">
                      <Scroll size={32} />
                    </div>
                    
                    <h2 className="text-2xl font-bold text-yellow-300 mb-1">é¦¬å¹´è¡Œå¤§é‹</h2>
                    <p className="text-red-200 text-sm mb-6 uppercase tracking-widest">HAPPY NEW YEAR 2026</p>
                    
                    <div className="bg-white/10 backdrop-blur-sm rounded-xl p-6 mb-6 border border-white/20 relative overflow-hidden">
                      {/* Mascot Stamp */}
                      {selectedMascot && (
                        <div className="absolute -right-2 -top-2 opacity-90 transform rotate-12 bg-white text-slate-800 p-2 rounded-lg shadow-lg border-2 border-yellow-400 z-20 flex flex-col items-center">
                          <span className="text-3xl filter drop-shadow-md">{selectedMascot.icon}</span>
                          <span className="text-[8px] font-bold bg-red-600 text-white px-1 rounded mt-1">
                            {selectedMascot.name}
                          </span>
                        </div>
                      )}

                      <p className="text-lg font-bold mb-4 text-left">
                        To <span className="text-yellow-300 text-xl border-b border-yellow-300/50 pb-1">{recipientName || 'è¦ªæ„›çš„æœ‹å‹'}</span>ï¼š
                      </p>
                      
                      <div className="space-y-4 text-left">
                        {selectedGreetings.map(id => {
                          const item = GREETING_OPTIONS.find(g => g.id === id);
                          return (
                            <div key={id} className="flex gap-3 items-start">
                              <div className="mt-1 text-yellow-400 flex-shrink-0">{item.icon}</div>
                              <div>
                                <p className="font-bold text-white text-lg">{item.blessing.split('ï¼Œ')[0]}ï¼Œ</p>
                                <p className="text-red-100">{item.blessing.split('ï¼Œ')[1]}</p>
                              </div>
                            </div>
                          );
                        })}
                      </div>

                      <p className="text-right mt-6 font-bold text-lg">
                        From <span className="text-yellow-300 text-xl border-b border-yellow-300/50 pb-1">{senderName || 'æ‚¨çš„å¥½å‹'}</span>
                      </p>
                    </div>

                    <div className="text-xs text-red-300/60 font-mono flex items-center justify-center gap-1">
                      <Sparkles size={10}/> è¬é¦¬å¥”é¨°ãƒ»å¥åº·ä¸è…«
                    </div>
                  </div>

                  {/* QR Code Footer Section */}
                  <div className="absolute bottom-0 left-0 w-full bg-white p-4 flex items-center justify-between z-20 shadow-[0_-5px_15px_rgba(0,0,0,0.2)]">
                     <div className="flex items-center gap-3">
                        <div className="bg-slate-100 p-1 rounded-lg border border-slate-200">
                           {/* Using external API to generate QR Code. In production, use a library like qrcode.react */}
                           <img 
                             src={`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(shareUrl)}`} 
                             alt="Scan to Play" 
                             className="w-16 h-16 mix-blend-multiply"
                           />
                        </div>
                        <div className="text-left">
                           <p className="text-[10px] text-slate-400 font-bold mb-0.5 uppercase tracking-wide">Join the Challenge</p>
                           <p className="text-sm font-bold text-red-700 leading-tight">æƒæåŠ å…¥<br/>å¥åº·è³“æœæŒ‘æˆ°</p>
                        </div>
                     </div>
                     <div className="text-right hidden sm:block">
                        <p className="text-[10px] text-slate-400">ä¸€èµ·å¥åº·éå¥½å¹´</p>
                     </div>
                  </div>
                </div>

                <div className="mt-6 flex justify-center gap-4">
                  <button 
                    onClick={() => setShowGeneratedCard(false)}
                    className="px-6 py-2 rounded-full bg-slate-200 text-slate-600 font-bold text-sm hover:bg-slate-300 transition-colors"
                  >
                    è¿”å›ä¿®æ”¹
                  </button>
                  <button 
                    onClick={() => alert('è«‹ä½¿ç”¨æ‰‹æ©Ÿæˆªåœ–åŠŸèƒ½ä¿å­˜é€™å¼µå¡ç‰‡ï¼Œç„¶å¾Œå‚³é€çµ¦æœ‹å‹å–”ï¼')}
                    className="px-6 py-2 rounded-full bg-red-600 text-white font-bold text-sm shadow-md hover:bg-red-700 transition-colors"
                  >
                    ä¿å­˜/åˆ†äº«
                  </button>
                </div>
              </div>
            )}
          </div>
        )}

      </div>

      {/* RANDOM TASK MODAL */}
      {showTaskModal && randomTask && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
          <div className="bg-white rounded-3xl p-6 max-w-sm w-full shadow-2xl transform transition-all scale-100">
             <div className="text-center">
                <div className="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                   <Bot size={32} />
                </div>
                <h3 className="text-xl font-bold text-slate-800 mb-1">é›»è…¦æŒ‡å®šä»»å‹™</h3>
                <p className="text-sm text-slate-400 mb-6">å‘½é‹ä¹‹ç¥èªªï¼Œä½ ç¾åœ¨è©²åšé€™å€‹ï¼</p>
                
                <div className="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-6 mb-6">
                   <div className="text-yellow-600 mb-2 flex justify-center">
                      {getIcon(randomTask.id, randomTask.type)}
                   </div>
                   <p className="text-xl font-bold text-slate-800">{randomTask.text}</p>
                </div>

                <div className="flex gap-3">
                   <button 
                     onClick={() => setShowTaskModal(false)}
                     className="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition-colors"
                   >
                     ç¨å¾Œå†åš
                   </button>
                   <button 
                     onClick={completeRandomTask}
                     className="flex-1 py-3 bg-red-600 text-white font-bold rounded-xl shadow-lg hover:bg-red-700 transition-colors"
                   >
                     ç«‹å³å®Œæˆï¼
                   </button>
                </div>
                <button 
                  onClick={pickRandomTask} 
                  className="mt-4 text-xs text-slate-400 underline hover:text-red-500"
                >
                  æ›ä¸€å€‹ä»»å‹™
                </button>
             </div>
          </div>
        </div>
      )}
      
      {/* Bottom Navigation */}
      <div className="fixed bottom-0 left-0 w-full bg-white border-t border-slate-100 shadow-[0_-5px_15px_rgba(0,0,0,0.05)] pb-safe pt-2 px-6 flex justify-around items-end z-50 h-20">
         <button 
           onClick={() => setActiveTab('bingo')}
           className={`flex flex-col items-center gap-1 p-2 pb-4 transition-colors ${activeTab === 'bingo' ? 'text-red-600' : 'text-slate-400 hover:text-slate-600'}`}
         >
           <Check size={24} className={activeTab === 'bingo' ? 'stroke-[2.5px]' : ''}/>
           <span className="text-[10px] font-bold">è³“æœä»»å‹™</span>
         </button>

         <button 
           onClick={() => setActiveTab('gacha')}
           className={`flex flex-col items-center gap-1 p-2 pb-4 transition-colors ${activeTab === 'gacha' ? 'text-red-600' : 'text-slate-400 hover:text-slate-600'}`}
         >
           <Gift size={24} className={activeTab === 'gacha' ? 'stroke-[2.5px]' : ''}/>
           <span className="text-[10px] font-bold">é´»é‹æŠ½ç±¤</span>
         </button>

         <button 
           onClick={() => setActiveTab('card')}
           className={`flex flex-col items-center gap-1 p-2 pb-4 transition-colors ${activeTab === 'card' ? 'text-red-600' : 'text-slate-400 hover:text-slate-600'}`}
         >
           <Scroll size={24} className={activeTab === 'card' ? 'stroke-[2.5px]' : ''}/>
           <span className="text-[10px] font-bold">å¥åº·è³€å¡</span>
         </button>
      </div>

    </div>
  );
};

export default BingoGame;
